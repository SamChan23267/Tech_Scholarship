<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='section_template.css') }}">
</head>
<body>

    {% include 'navbar_auth.html' %}
    {% include 'flashmessage.html' %}

    <div class="container">
        <div class="left-section">
            <div class="course-navigation">
                <div class="section-section">   
                    <a href="{{ url_for('section_detail', level=level, topic_name=topic_name, unit_name=unit_name, section_name=section_name) }}">{{ section_display_name }}</a>
                </div> 
                <div class="sub-section-section">
                    <ul>
                        {% for sub_section in sub_sections %}
                        <li>
                            <a href="{{ url_for('sub_section_detail', level=level, topic_name=topic_name, unit_name=unit_name, section_name=section_name, sub_section_name=sub_section.name) }}" class="sub-section-link">
                                <span>{{ sub_section.display_name }}</span>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>    
        </div>

        <div class="right-section">
            <main>
                <div class="main-content">
                    {% if is_section %}
                        <h1>{{ title }}</h1>
                        <p>{{ section_content }}</p>
                        <!-- Add more content as needed -->
                    {% else %} <!--if not section-->
                        <h1>{{ title }}</h1>
                        {% if sub_section_type == 'video' %}
                            <video controls>
                                <source src="{{ sub_section_content }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        {% elif sub_section_type == 'notes' %}
                            <p>{{ sub_section_content|safe }}</p>
                        {% elif sub_section_type == 'practice' %}
                            <!-- Start Page Section -->
                            <div id="start-page">
                                <h2>Welcome to the Quiz</h2>
                                <p>Click the button below to start the quiz.</p>
                                <button onclick="startQuiz()">Start Quiz</button>
                            </div>

                            <!-- Quiz Container -->
                            <div id="quiz-container" style="display:none;">
                                {% for question_id, question in sub_section_content.questions.items() %}
                                    {% if question.type == 'multiple_choice' %}
                                        <div class="quiz-question" style = "display:none;">
                                            <p>{{ question.question }}</p>
                                            <ul>
                                                {% for option in question.options %}
                                                    <li>
                                                        <input type="radio" name="question_{{ question_id }}" value="{{ option }}">
                                                        <label>{{ option }}</label>
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                            <button onclick="checkMultipleChoiceAnswer('{{ question_id }}')">Submit</button>
                                        </div>
                                    {% elif question.type == 'open_ended' %}
                                        <div class="quiz-question" style="display:none;">
                                            <p>{{ question.question }}</p>
                                            <textarea name="question_{{ question_id }}" rows="4" cols="50"></textarea>
                                            <button onclick="checkOpenEndedAnswer('{{ question_id }}')">Submit</button>
                                        </div>
                                    {% elif question.type == 'coordinate_plane' %}
                                        <!-- Add coordinate plane question rendering logic here -->
                                    {% elif question.type == 'matching' %}
                                        <!-- Add matching question rendering logic here -->
                                    {% endif %}
                                {% endfor %}
                                <input type="hidden" id="current_question_id" value="0">
                            </div>

                            <!-- End Page Section -->
                            <div id="end-page" style="display:none;">
                                <h2>Quiz Completed</h2>
                                <p>Your score: <span id="score"></span></p>
                                <button onclick="restartQuiz()">Restart Quiz</button>
                            </div>

                        {% endif %}
                    {% endif %}
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get the current URL path
            const currentPath = window.location.pathname;

            // Function to set the active class based on the current URL
            function setActiveClass() {
                // Remove active class from all section and sub-section boxes
                document.querySelectorAll('.section-section a, .sub-section-section li a').forEach(function(element) {
                    element.classList.remove('active');
                });

                // Check for section detail URL
                document.querySelectorAll('.section-section a').forEach(function(element) {
                    const href = element.getAttribute('href');
                    if (currentPath === href) {
                        element.classList.add('active');
                    }
                });

                // Check for sub-section detail URL
                document.querySelectorAll('.sub-section-section li a').forEach(function(element) {
                    const href = element.getAttribute('href');
                    if (currentPath === href) {
                        element.classList.add('active');
                    }
                });
            }

            // Set the active class when the page loads
            setActiveClass();
        });
        </script>
        {% if not is_section %}
        {% if sub_section_type == 'practice' %}
    
        <script>
            let currentQuestionIndex = 0;
            let score = 0;
            const questions = document.querySelectorAll('.quiz-question');
            let attempt = false;
          
            // Function to start the quiz
            function startQuiz() {
                document.getElementById('start-page').style.display = 'none';
                document.getElementById('quiz-container').style.display = 'block';
                showQuestion(0);
            }

            // Function to check the answer for multiple choice questions
            function checkMultipleChoiceAnswer(questionId) {
                const selectedOptionElement = document.querySelector('input[name="question_' + questionId + '"]:checked');
                if (selectedOptionElement) {
                    const selectedOption = JSON.stringify(selectedOptionElement.value);
                    const correctAnswer = JSON.stringify(JSON.parse('{{ sub_section_content.questions|tojson }}')[questionId].answer);
                    if (selectedOption === correctAnswer) {
                        alert('Correct answer! Moving to the next question.');

                        // Update the current question index
                        const currentQuestionIdElement = document.getElementById('current_question_id');
                        let currentQuestionIndex = parseInt(currentQuestionIdElement.value);
                        currentQuestionIndex += 1;
                        currentQuestionIdElement.value = currentQuestionIndex;
                        
                        // Add score if the question is answered correctly in first attempt
                        if (attempt == false) {
                            score ++;
                        }

                        // Logic to move to the next question
                        showQuestion(currentQuestionIndex);

                    } else {
                        // Logic for incorrect answer
                        alert('Incorrect answer. Please try again.');
                        attempt = true;
                    }
                } else {
                    alert('No option selected.');
                }
            }
            
            //Function to check the answer for open ended questions
            function checkOpenEndedAnswer(questionId) {
                const userAnswer = document.querySelector(`textarea[name="question_${questionId}"]`).value.trim();
                if (userAnswer) {
                    var correctAnswer = JSON.parse('{{ sub_section_content.questions|tojson }}')[questionId].answer
                    if (correctAnswer.includes(userAnswer)) {
                        alert('Correct answer! Moving to the next question.');

                        // Update the current question index
                        const currentQuestionIdElement = document.getElementById('current_question_id');
                        let currentQuestionIndex = parseInt(currentQuestionIdElement.value);
                        currentQuestionIndex += 1;
                        currentQuestionIdElement.value = currentQuestionIndex;

                        // Add score if the question is answered correctly in first attempt
                        if (attempt == false) {
                            score ++;
                        }

                        // Logic to move to the next question
                        showQuestion(currentQuestionIndex);
                        
                    } else {
                        // Logic for incorrect answer
                        alert('Incorrect answer. Please try again.');
                        attempt = true;
                    }
                } else {
                    alert('No answer inputted.');
                }
            }
        
            // Function to show the question based on the current question index
            function showQuestion(questionIndex) {
                const questions = document.querySelectorAll('.quiz-question');
                attempt = false;
                
                if (questionIndex < questions.length) {
                    questions.forEach((question, index) => {
                        if (index === questionIndex) {
                            question.style.display = 'block';
                        } else {
                            question.style.display = 'none';
                        }
                    });
                } else {
                    endQuiz('{{ sub_section_id }}');
                }
            }
            
            function endQuiz(subSectionId) {
                document.getElementById('quiz-container').style.display = 'none';
                document.getElementById('end-page').style.display = 'block';
                const percentageScore = ((score/questions.length)*100).toFixed(2);
                document.getElementById('score').innerText = score + '/' + questions.length + '(' + percentageScore + '%)';


                const endPageElement = document.getElementById('end-page');
                endPageElement.classList.remove('full-mark', 'high-mark', 'mid-mark', 'low-mark');

                if (percentageScore === 100) {
                    endPageElement.classList.add('full-mark');
                } else if (percentageScore >= 75) {
                    endPageElement.classList.add('high-mark');
                } else if (percentageScore >= 50) {
                    endPageElement.classList.add('mid-mark');
                } else {
                    endPageElement.classList.add('low-mark');
                }
                
                        // Send the score to the server
                fetch('/update_score', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sub_section_id: subSectionId,
                        score: score
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Score updated successfully!');
                    } else {
                        alert('Failed to update score.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
                
            

            

            function restartQuiz() {
                window.location.reload();
            }    

            
        </script>
        
        {% endif %}

        {% endif %}
</body>
</html>